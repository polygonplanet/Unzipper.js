<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Unzip and Drop file in JavaScript</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="js/pot.min.js"></script>
<script src="js/inflate.js"></script>
<script src="js/unzipper.js"></script>
<script src="js/encoding.js"></script>
<script>
$(function() {
  run();

  function valid(name) {
    console.log(name);
    if (!/\.zip$/i.test(name)) {
      var warn = $('<div/>')
        .css({color : 'red'})
        .text('This is not zip file.')
        .appendTo('#container');

      Pot.callLater(2.5, function() {
        warn.fadeOut(function() {
          warn.empty().remove();
        });
      });
      return false;
    } else {
      return true;
    }
  }


  function run() {
    var container = $('#container');
    var processing = $('#processing');

    return Pot.Deferred.begin(function() {
      var panel = $('#drop')
        .remove()
        .appendTo('body');

      $('#drop-wrap').remove();

      var dropFile = new Pot.DropFile(panel, {
        onShow : function() {
          panel.show();
        },
        onHide : function() {
          panel.hide();
        },
        onLoadImage : function(data, name, size, type) {
          valid(name);
        },
        onLoadText : function(data, name, size, type) {
          valid(name);
        },
        onLoadUnknown : function(data, name, size, type) {
          if (!valid(name)) {
            return;
          }

          $('<div/>')
            .text(
              Pot.sprintf('name: %s, type: %s, size: %d',
                name, type, size
              )
            )
            .appendTo(container);

          processing.text('processing...');
          var unzipper = new Unzipper();
          unzipper.isConvertEncodingToUTF8 = true;
          unzipper.unzip(data, size, function(res) {
            if (res) {
              $('<p/>')
                .text(
                  Pot.sprintf('name: %s, date: %s',
                    res.name,
                    Pot.date('Y-m-d H:i:s', res.time)
                  )
                )
                .appendTo(container);

              $('<textarea/>')
                .val(res.data)
                .appendTo(container);
            }

          }, function(err) {
            $('<h3/>')
              .css({color : 'red'})
              .text(Pot.isString(err) ? err : Pot.getErrorMessage(err))
              .appendTo(container);

          }).ensure(function(res) {
            processing.text('');

            $('<h2/>')
              .css({color : 'blue'})
              .text('Done.')
              .appendTo(container);

            if (Pot.isError(res)) {
              throw res;
            }
            //Pot.debug(res);

          });
        }
      });
    });
  }
});
</script>
<style>
#drop-wrap {
  display: none;
}

#drop {
  position: fixed;
  left: 10%;
  top: 10%;
  width: 80%;
  height: 80%;
  min-height: 200;
  background: #ff8cd3;
  z-index: 9999999;
  display: table;
  text-align: center;
  -webkit-box-shadow: 1px 1px 10px #333;
  -moz-box-shadow: 1px 1px 10px #333;
  box-shadow: 1px 1px 10px #333;
}

#drop .drop-text {
  display: table-cell;
  color: #fff;
  font-weight: bold;
  vertical-align: middle;
  font-size: 160%;
}

textarea {
  width: 98%;
  height: 200px;
}

#container {
  margin: 1em;
}

#processing {
  font-weight: bold;
}

#footer {
  margin: 0.5em auto;
  text-align: center;
}
</style>
</head>
<body>
<h1>JavaScriptでzipファイルを展開します</h1>
<p>
 適当な zip ファイルをデスクトップなどからドロップすると解凍したデータが表示されます。
 <br>
 非同期で処理しているので、たぶん重いファイルでも負荷を抑えて解凍できます (その場合メモリに注意)。
 <br>
 文字コードは UTF-8 に合わせて変換して表示します。
 <br>
 ※このページ内のみで表示するためデータは外部サーバーなどに送られません。
</p>
<p>
 HTML5 File API, ArrayBuffer, DropEvent がサポートされてるブラウザのみ動きます (Firefox, GoogleChrome etc.)
</p>
<p>
 Drop zip file here.
</p>
<div id="drop-wrap">
  <div id="drop">
    <div class="drop-text">Drop zip file here.</div>
  </div>
</div>

<div id="container"></div>
<div id="processing"></div>

<p id="footer">
  <a href="https://github.com/polygonplanet/Unzipper.js">Repository in GitHub</a>
  <a href="https://github.com/polygonplanet/Unzipper.js"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a>
</p>
</body>
</html>